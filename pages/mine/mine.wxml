<!-- 我的页面 -->
<view class="container mine-container fade-in">
  <!-- Profile Card -->
  <view class="profile-card" style="width: 708rpx; display: flex; box-sizing: border-box; position: relative; left: -24rpx; top: -43rpx">
    <view class="profile-left">
      <image class="avatar" src="{{avatarUrl || '/assets/avatar-placeholder.png'}}" mode="aspectFill" />
      <view class="meta">
        <text class="nickname">{{nickName || '微信用户'}}</text>
        <text class="subtitle">麻将计分达人</text>
      </view>
    </view>
    <button class="btn-outline" bindtap="gotoEditProfile" style="width: 199rpx; display: block; box-sizing: border-box; left: 115rpx; top: -5rpx; position: relative">修改资料</button>
  </view>

  <!-- 原"数据统计"整块隐藏 -->
  <view wx:if="{{false}}">
    <!-- 原先的年份/月选择UI，保留以便回滚 -->
    <view class="time-filter card">
      <view class="filter-title">
        <text class="title-medium">数据统计</text>
        <text class="filter-subtitle text-secondary">选择查看时间范围</text>
      </view>
      <view class="filter-controls">
        <picker mode="selector" range="{{yearList}}" value="{{yearList.indexOf(selectedYear)}}" bindchange="onYearChange">
          <view class="time-picker" style="width: 324rpx; display: flex; box-sizing: border-box">
            <text class="picker-label">年份</text>
            <view class="picker-value">
              <text class="value-text">{{selectedYear}}</text>
              <text class="picker-arrow">▼</text>
            </view>
          </view>
        </picker>
        <picker mode="selector" range="{{monthList}}" value="{{monthList.indexOf(selectedMonth)}}" bindchange="onMonthChange">
          <view class="time-picker" style="width: 329rpx; display: flex; box-sizing: border-box">
            <text class="picker-label">月份</text>
            <view class="picker-value">
              <text class="value-text">{{selectedMonth}}</text>
              <text class="picker-arrow">▼</text>
            </view>
          </view>
        </picker>
      </view>
    </view>
  </view>

  <!-- 核心数据 头部 + 时间筛选 -->
  <view class="overview-card card">
    <view class="section-header">
      <text class="title">核心数据</text>

      <view class="controls">
        <!-- 月份胶囊：使用 date picker fields=month，稳定不抖动 -->
        <picker mode="date" fields="month" value="{{monthValue}}" bindchange="onMonthChange">
          <view class="pill">{{ monthLabel }}</view>
        </picker>

        <!-- 右侧轻按钮：按年统计 / 按月统计（切换） -->
        <button class="btn-ghost" bindtap="onToggleYearMode">
          {{ mode === 'year' ? '按月统计' : '按年统计' }}
        </button>

        <!-- 隐藏的年份选择器：仅在进入 year 模式时弹一次 -->
        <picker wx:if="{{showYearPicker}}" mode="selector" range="{{yearOptions}}" value="{{yearIndex}}" bindchange="onYearPicked" bindcancel="onYearPickCancel">
          <view style="display:none;"></view>
        </picker>
      </view>
    </view>
    <view class="metrics-grid">
      <view class="metric-item">
        <view class="metric-icon games-icon">🎮</view>
        <text class="metric-value text-primary">{{personalSummary.totalGames}}</text>
        <text class="metric-label text-secondary">总场数</text>
      </view>
      <view class="metric-item">
        <view class="metric-icon win-icon">🏆</view>
        <text class="metric-value text-success">{{personalSummary.totalWins}}</text>
        <text class="metric-label text-secondary">胜场</text>
      </view>
      <view class="metric-item">
        <view class="metric-icon rate-icon">📊</view>
        <text class="metric-value text-warning">{{personalSummary.winRate}}%</text>
        <text class="metric-label text-secondary">胜率</text>
      </view>
      <view class="metric-item">
        <view class="metric-icon score-icon">💰</view>
        <text class="metric-value {{personalSummary.totalScore >= 0 ? 'text-success' : 'text-danger'}}">{{personalSummary.totalScore}}</text>
        <text class="metric-label text-secondary">总得分</text>
      </view>
    </view>
  </view>

  <!-- 详细统计 -->
  <view class="detailed-stats card">
    <view class="stats-header">
      <text class="section-title title-medium">详细统计</text>
      <text class="expand-hint text-light">展开查看更多数据</text>
    </view>
    
    <!-- 详细数据网格 -->
    <view class="detailed-grid">
      <!-- 基础数据卡片 -->
      <view class="detail-card">
        <view class="detail-header">
          <text class="detail-title text-secondary">基础数据</text>
        </view>
        <view class="detail-metrics">
          <view class="detail-metric">
            <text class="metric-value text-danger">{{personalSummary.totalLosses}}</text>
            <text class="metric-label text-light">总负场</text>
          </view>
          <view class="detail-metric">
            <text class="metric-value text-success">{{personalSummary.totalWinScore}}</text>
            <text class="metric-label text-light">总胜分</text>
          </view>
          <view class="detail-metric">
            <text class="metric-value text-danger">{{personalSummary.totalLossScore}}</text>
            <text class="metric-label text-light">总负分</text>
          </view>
        </view>
      </view>

      <!-- 倍率数据卡片 -->
      <view class="detail-card">
        <view class="detail-header">
          <text class="detail-title text-secondary">倍率数据</text>
        </view>
        <view class="detail-metrics">
          <view class="detail-metric">
            <text class="metric-value {{personalSummary.totalMultiplierScore >= 0 ? 'text-success' : 'text-danger'}}">{{personalSummary.totalMultiplierScore}}</text>
            <text class="metric-label text-light">倍率总分</text>
          </view>
          <view class="detail-metric">
            <text class="metric-value text-success">{{personalSummary.totalMultiplierWinScore}}</text>
            <text class="metric-label text-light">倍率胜分</text>
          </view>
          <view class="detail-metric">
            <text class="metric-value text-danger">{{personalSummary.totalMultiplierLossScore}}</text>
            <text class="metric-label text-light">倍率负分</text>
          </view>
        </view>
      </view>
    </view>
  </view>

  <!-- 对手统计 -->
  <view class="opponent-stats card" wx:if="{{stats.length > 0}}">
    <view class="stats-header">
      <text class="section-title title-medium">对手统计</text>
      <text class="stats-subtitle text-secondary">与各位玩家的对战记录</text>
    </view>
    <view class="opponent-list">
      <block wx:for="{{stats}}" wx:key="name">
        <view class="opponent-item">
          <view class="opponent-info">
            <view class="opponent-avatar">
              <text class="avatar-initial">{{item.name.charAt(0)}}</text>
            </view>
            <text class="opponent-name text-primary">{{item.name}}</text>
          </view>
          <view class="opponent-score">
            <text class="score-value {{item.cls}}">{{item.total >= 0 ? '+' : ''}}{{item.total}}</text>
            <text class="score-label text-light">总分差</text>
          </view>
        </view>
      </block>
    </view>
  </view>

  <!-- 空状态 -->
  <view class="empty-stats card" wx:else>
    <view class="empty-state">
      <text class="empty-icon">📈</text>
      <text class="empty-title">暂无统计数据</text>
      <text class="empty-desc">开始游戏后会显示详细统计</text>
    </view>
  </view>
</view>