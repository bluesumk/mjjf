<!-- scoring.wxml - è®°åˆ†é¡µé¢ -->
<view class="container scoring-container">
  <!-- è¾“å…¥é˜¶æ®µ -->
  <view wx:if="{{stage === 'input'}}" class="input-stage">
    <!-- å±€æ•°æ ‡é¢˜ -->
    <view class="round-header">
      <text class="round-title">ç¬¬{{roundNumber}}å±€</text>
    </view>

    <!-- è®¡åˆ†è¡¨æ ¼ -->
    <view class="scoring-table">
      <!-- è¡¨å¤´ -->
      <view class="table-header">
        <view class="header-cell name-cell">åç§°</view>
        <view class="header-cell role-cell">èƒœè´Ÿ</view>
        <view class="header-cell score-cell">å¾—åˆ†</view>
      </view>

      <!-- ç©å®¶è¡Œ -->
      <block wx:for="{{participants}}" wx:key="index">
        <view class="table-row">
          <!-- ç©å®¶åç§°å’Œå¤´åƒ -->
          <view class="name-cell">
            <view class="player-avatar {{item === 'å°' ? 'tai-avatar' : ''}}">
              <text class="avatar-text">{{item === 'å°' ? 'å°' : item.charAt(0)}}</text>
            </view>
            <text class="player-name">{{item}}</text>
          </view>

          <!-- èƒœè´Ÿé€‰æ‹© -->
          <view class="role-cell">
            <view class="role-buttons" wx:if="{{item !== 'å°'}}">
              <view class="role-btn win-btn {{roles[index] === 'win' ? 'active' : ''}}" 
                    data-index="{{index}}" data-role="win" bindtap="onRoleToggle">
                <text class="role-text">èƒœ</text>
              </view>
              <view class="role-btn lose-btn {{roles[index] === 'lose' ? 'active' : ''}}" 
                    data-index="{{index}}" data-role="lose" bindtap="onRoleToggle">
                <text class="role-text">è´Ÿ</text>
              </view>
            </view>
            <text wx:else class="tai-no-role text-secondary">--</text>
          </view>

          <!-- åˆ†æ•°è¾“å…¥ -->
          <view class="score-cell">
            <block wx:if="{{index < participants.length - 1}}">
              <input type="number" class="score-input {{item === 'å°' ? 'tai-input' : ''}}" 
                     data-index="{{index}}" 
                     value="{{scores[index]}}" 
                     bindinput="{{item === 'å°' ? 'onTaiScoreInput' : 'onScoreInput'}}" 
                     placeholder="0">
              </input>
            </block>
            <block wx:else>
              <text class="auto-score">{{scores[index] || 0}}</text>
            </block>
          </view>
        </view>
      </block>
    </view>

    <!-- æ“ä½œæŒ‰é’® -->
    <view class="action-buttons">
      <button type="primary" class="confirm-btn" bindtap="confirmScores" 
              disabled="{{scoreSum !== 0 || hasEmpty}}">
        ç¡®å®š
      </button>
      <button type="default" class="cancel-btn" bindtap="cancelInput">
        å–æ¶ˆ
      </button>
    </view>
  </view>

  <!-- å•å±€ç»Ÿè®¡é˜¶æ®µ -->
  <view wx:elif="{{stage === 'summary'}}" class="summary-stage">
    <view class="summary-header card">
      <text class="summary-title title-large">ç¬¬{{roundNumber - 1}}å±€ç»“æœ</text>
      <text class="summary-subtitle text-secondary">æœ¬å±€è®¡åˆ†å·²å®Œæˆ</text>
    </view>

    <view class="summary-list">
      <block wx:for="{{participants}}" wx:key="index">
        <view class="summary-item card">
          <view class="summary-player">
            <text class="summary-name title-small">{{item}}</text>
          </view>
          <view class="summary-score {{summaryClasses[index]}}">
            <text class="score-value">{{summaryScores[index] >= 0 ? '+' : ''}}{{summaryScores[index]}}</text>
          </view>
        </view>
      </block>
    </view>

    <view class="summary-actions">
      <button type="primary" class="next-round-btn" bindtap="startNextRound">
        <text class="btn-icon">â–¶</text>
        <text class="btn-text">ç»§ç»­ä¸‹å±€</text>
      </button>
      <button type="warn" class="finish-btn" bindtap="openMultiplierInput">
        <text class="btn-icon">ğŸ</text>
        <text class="btn-text">ç»“æŸæ”¶ç›˜</text>
      </button>
    </view>
  </view>

  <!-- æ”¶ç›˜å®Œæˆé˜¶æ®µ -->
  <view wx:elif="{{stage === 'final'}}" class="final-stage">
    <view class="final-header card">
      <text class="final-title title-large">ğŸ‰ å¯¹å±€ç»“æŸ</text>
      <text class="final-subtitle text-secondary">æœ€ç»ˆæˆç»©å•</text>
    </view>

    <view class="final-list">
      <block wx:for="{{finalList}}" wx:key="name" wx:for-index="rank">
        <view class="final-item card">
          <view class="rank-badge {{rank === 0 ? 'champion' : ''}}">
            <text class="rank-number">{{rank + 1}}</text>
          </view>
          <view class="final-player">
            <text class="final-name title-small">{{item.name}}</text>
          </view>
          <view class="final-score {{item.cls}}">
            <text class="final-value">{{item.score >= 0 ? '+' : ''}}{{item.score}}</text>
          </view>
        </view>
      </block>
    </view>

    <view class="final-actions">
      <button type="primary" class="home-btn" bindtap="goHome">
        <text class="btn-icon">ğŸ </text>
        <text class="btn-text">å›åˆ°é¦–é¡µ</text>
      </button>
    </view>
  </view>

  <!-- å€æ•°è¾“å…¥å¼¹çª— -->
  <view wx:if="{{showMultiplierInput}}" class="modal-overlay">
    <view class="modal-container card">
      <view class="modal-header">
        <text class="modal-title title-medium">è®¾ç½®å€ç‡</text>
        <text class="modal-subtitle text-secondary">è¾“å…¥æœ€ç»ˆå€ç‡ï¼ˆæ•´æ•°ï¼‰</text>
      </view>
      
      <view class="modal-body">
        <input type="number" class="multiplier-input" 
               bindinput="handleMultiplierInput" 
               value="{{multiplierInput}}" 
               placeholder="1">
        </input>
        <text class="multiplier-tip text-light">é»˜è®¤å€ç‡ä¸º1ï¼Œå¯è¾“å…¥å…¶ä»–æ•´æ•°</text>
      </view>
      
      <view class="modal-actions">
        <button type="default" class="modal-cancel" bindtap="cancelMultiplier">å–æ¶ˆ</button>
        <button type="primary" class="modal-confirm" bindtap="confirmMultiplier">ç¡®è®¤</button>
      </view>
    </view>
  </view>
</view>